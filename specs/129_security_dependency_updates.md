# Spec 129: Security Dependency Updates

## Status: COMPLETE

**Priority:** High
**Complexity:** Low
**Prerequisites:** None

---

## Problem Statement

GitHub Dependabot flagged 10 security vulnerabilities in the janus-poc repository. All vulnerabilities are in the UI (Next.js frontend) dependencies.

---

## Vulnerabilities

### High Priority - Direct Dependencies

| Package | Current | Vulnerability | GHSA | Fix |
|---------|---------|---------------|------|-----|
| next | 16.1.4 | Unbounded Memory via PPR Resume | GHSA-5f7q-jpqc-wp7h | Update to 16.1.6+ |
| next | 16.1.4 | DoS via insecure RSC | GHSA-h25m-26qc-wcjf | Update to 16.1.6+ |
| next | 16.1.4 | DoS via Image Optimizer | GHSA-9g9p-9gw9-jx7f | Update to 16.1.6+ |
| xlsx | 0.18.5 | ReDoS | GHSA-5pgg-2g8v-p4x9 | No fix available |
| xlsx | 0.18.5 | Prototype Pollution | GHSA-4r6h-8v6p-xvw6 | No fix available |

### Moderate Priority - Transitive Dependencies

| Package | Via | Vulnerability | GHSA | Fix |
|---------|-----|---------------|------|-----|
| lodash-es | mermaid → chevrotain | Prototype Pollution in _.unset/_.omit | GHSA-xxjr-mmjv-4gpg | npm update |
| prismjs | react-syntax-highlighter → refractor | DOM Clobbering | GHSA-x7hr-w5r2-h6wg | npm update |

---

## Implementation

### 1. Update Next.js

```bash
cd ui
npm install next@latest
```

This should update from 16.1.4 to 16.1.6+ which fixes all three Next.js vulnerabilities.

### 2. Update Transitive Dependencies

```bash
cd ui
npm update
```

This will update transitive dependencies where possible:
- `lodash-es` should update to 4.17.23 (already some versions at this)
- `prismjs` should update where possible

### 3. Handle xlsx Vulnerabilities

The `xlsx` (SheetJS) package has known vulnerabilities with no fix available in the current version. Options:

**Option A: Accept Risk (Recommended)**
- xlsx is used for spreadsheet export functionality
- Vulnerabilities require malicious input to exploit
- Risk is low for our use case (generating exports, not parsing untrusted files)
- Add comment in code documenting accepted risk

**Option B: Remove xlsx**
- Remove spreadsheet export functionality
- Not recommended if feature is needed

**Option C: Use Alternative**
- Consider `exceljs` as alternative (more actively maintained)
- Requires code changes

### 4. Run npm audit

```bash
cd ui
npm audit
npm audit fix
```

### 5. Verify Build

```bash
cd ui
npm run build
npm run test
npm run typecheck
```

---

## Files to Modify

- `ui/package.json` - Update dependency versions
- `ui/package-lock.json` - Regenerated by npm

---

## Acceptance Criteria

- [x] Next.js updated to 16.1.6+
- [x] `npm audit` shows reduced vulnerabilities (11 → 1)
- [x] Build passes without errors
- [x] Tests pass (42/42)
- [x] Type checking passes
- [x] xlsx vulnerabilities documented/accepted (no fix available, low risk for export-only usage)

## Implementation Summary

**Vulnerabilities reduced from 11 to 1:**

| Fix | Method |
|-----|--------|
| Next.js 3 CVEs | Already at 16.1.6 |
| prismjs DOM Clobbering | Updated react-syntax-highlighter to 16.1.0 |
| lodash-es Prototype Pollution | Added npm override for lodash-es@^4.17.23 |
| xlsx (2 CVEs) | No fix available - accepted risk (export-only, no untrusted input parsing) |

**Changes made:**
- `ui/package.json`: Added `overrides` section for lodash-es, updated react-syntax-highlighter
- `ui/package-lock.json`: Regenerated

---

## Testing

1. Run `npm audit` before and after updates
2. Run full test suite: `npm test`
3. Run build: `npm run build`
4. Verify app functions correctly in browser
5. Test spreadsheet export if xlsx retained

---

## Notes

- Some vulnerabilities in transitive dependencies may not be directly fixable
- After updates, verify mermaid diagrams still render correctly
- After updates, verify syntax highlighting still works
